#!/bin/sh

### Package: pbp-build-linux-hwaccel-crosscompile
### Version: v20200613.2355
### Author: Michael Gan "xmixahlx" michaelbgan@gmail.com
### License: GPLv3
### Script Dependencies: (none)

## VARS
RESDIR=`pwd`/resources
DEVDIR=`pwd`/upstream
LINUXREL=5.7
BUILDCONFIG="ARCH=arm64 CROSS_COMPILE=aarch64-none-linux-gnu-"
KERNELCONFIG="INITRD=yes KBUILD_IMAGE=arch/arm64/boot/Image"
TCPU=cortex-a72.cortex-a53
TOPTS=+crypto+crc+simd
TARCH=armv8-a
BUILDOPTS="-O2 -pipe"
GCCARMPKG=gcc-arm-9.2-2019.12-x86_64-aarch64-none-linux-gnu
GCCARMDIR=$DEVDIR/$GCCARMPKG

## OVERRIDE stable with HWACCELREL=testing
if [ -z $HWACCELREL ]; then
 HWACCELREL=stable
fi

## PATH
export PATH=$GCCARMDIR/bin:$PATH

## PREP
set -e
mkdir -p $DEVDIR
cd $DEVDIR

## GCC
[ -f $GCCARMPKG.tar.xz ] || wget https://developer.arm.com/-/media/Files/downloads/gnu-a/9.2-2019.12/binrel/$GCCARMPKG.tar.xz
[ -d $GCCARMDIR ] || tar xf $GCCARMPKG.tar.xz

## GET
rm -Rf linux-$LINUXREL
[ -f linux-$LINUXREL.tar.xz ] || wget https://cdn.kernel.org/pub/linux/kernel/v5.x/linux-$LINUXREL.tar.xz
tar xf linux-$LINUXREL.tar.xz

## PATCH
cd linux-$LINUXREL
patch -p1 < $RESDIR/linux/linux-pinebookpro-hwaccel_current-$HWACCELREL.diff

## CONFIGURE
cp $RESDIR/linux/hwaccel-config_current .config
make -j `nproc` $BUILDCONFIG oldconfig
make -j `nproc` $BUILDCONFIG menuconfig

## BUILD
KCFLAGS="$BUILDOPTS -march=$TARCH$TOPTS -mcpu=$TCPU -mtune=$TCPU" \
KCPPFLAGS="$BUILDOPTS -march=$TARCH$TOPTS -mcpu=$TCPU -mtune=$TCPU" \
make -j `nproc` $BUILDCONFIG $KERNELCONFIG bindeb-pkg;

## EXIT
exit
